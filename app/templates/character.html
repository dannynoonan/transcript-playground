{% extends "base.html" %}

{% block title %} 
	<title>{{ tdata['show_key'] }}: {{ tdata['speaker'] }}</title>
{% endblock %} 

{% block content %} 
	<div class="margin">

        <!-- BEGIN FIRST ROW -->
        <div class="row">

            <!-- BEGIN LEFT COLUMN -->
            <div class="col-8">

                <!-- begin top line info -->
                <h3><strong>{{ tdata['speaker'] }}</strong> character page</h3>
                {% if tdata['alt_names'] %}
                    <h5>a.k.a. {% for alt_name in tdata['alt_names'] %} 
                        <strong><i>{{ alt_name }}</strong></i>{% if not loop.last %},{% endif %}
                    {% endfor %}</h5>
                {% endif %}
                {% if tdata['actor_names'] %}
                    <h5>Played by {% for actor_name in tdata['actor_names'] %} 
                        <strong>{{ actor_name }}</strong>{% if not loop.last %},{% endif %}
                    {% endfor %}</h5>
                {% endif %}
                <h5>{{ tdata['episode_count'] }} episodes, {{ tdata['scene_count'] }} scenes, {{ tdata['scene_event_count'] }} lines, {{ tdata['word_count'] }} words</h5>
                <p>&nbsp;</p>
                <!-- end top line info -->

                <!-- begin seasons -->
                {% if tdata['seasons'] %}
                <h3>{{ tdata['season_count'] }} seasons with {{ tdata['speaker'] }}</h3>
                <div class="overflow-scroll" style="max-height: 600px;">
                    <table class="table table-hover table-striped table-fit">
                        <thead>
                            <tr class="table-success">
                                <th scope="col">Season</th>
                                <th scope="col">Episodes</th>
                                <th scope="col">Scenes</th>
                                <th scope="col">Lines</th>
                                <th scope="col">Words</th>
                                <th scope="col">Meyers-Briggs</th>
                                <th scope="col">D & D</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for season in tdata['seasons'] %}
                            <tr class="table-light">
                                <th scope="row">{{ season['season'] }}</th>
                                <td>{{ season['episode_count'] }}</td>
                                <td>{{ season['scene_count'] }}</td>
                                <td>{{ season['line_count'] }}</td>
                                <td>{{ season['word_count'] }}</td>
                                <td>
                                {% for topic in season['topics_mbti'] %}
                                    {% if loop.index < 4 %}
                                        {% set topic_names = topic['topic_name'].split('-') %}
                                        {{ topic['topic_key'] }}: {{ topic_names[0] }}{% if loop.index < 3 %}, {% endif %}
                                    {% endif %}
                                {% endfor %}
                                </td>
                                <td>
                                {% for topic in season['topics_dnda'] %}
                                    {% if loop.index < 4 %}
                                        {{ topic['topic_key'] }}{% if loop.index < 3 %}, {% endif %}
                                    {% endif %}
                                {% endfor %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p>&nbsp;</p>
                {% endif %}
                <!-- end seasons -->

                <!-- begin episodes -->
                <h3>{{ tdata['episode_count'] }} episodes with {{ tdata['speaker'] }}</h3>
                <div class="overflow-scroll" style="max-height: 600px;">
                    <table class="table table-hover table-striped table-fit">
                        <thead>
                            <tr class="table-success">
                                <th scope="col">Title</th>
                                <th scope="col">Season</th>
                                <th scope="col">Episode</th>
                                <th scope="col">Air date</th>
                                <th scope="col">Scenes</th>
                                <th scope="col">Lines</th>
                                <th scope="col">Words</th>
                                <th scope="col">Meyers-Briggs</th>
                                <th scope="col">D & D</th>
                                <th scope="col">Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for episode in tdata['episodes'] %}
                            <tr class="table-light">
                                <th scope="row"><a href="/web/episode/{{ episode['show_key'] }}/{{ episode['episode_key'] }}">{{ episode['title'] }}</a></th>
                                <td>{{ episode['season'] }}</td>
                                <td>{{ episode['sequence_in_season'] }}</td>
                                <td>{{ episode['air_date']|truncate(10,true,'') }}</td>
                                <td>{{ episode['scene_count'] }}</td>
                                <td>{{ episode['line_count'] }}</td>
                                <td>{{ episode['word_count'] }}</td>
                                <td>
                                {% for topic in episode['topics_mbti'] %}
                                    {% if loop.index < 3 %}
                                        {{ topic['topic_key'] }}{% if loop.index < 2 %}, {% endif %}
                                    {% endif %}
                                {% endfor %}
                                </td>
                                <td>
                                {% for topic in episode['topics_dnda'] %}
                                    {% if loop.index < 3 %}
                                        {{ topic['topic_key'] }}{% if loop.index < 2 %}, {% endif %}
                                    {% endif %}
                                {% endfor %}
                                </td>
                                <td>{{ '%0.2f'|format(episode['agg_score']|float) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p>&nbsp;</p>
                <!-- end episodes -->

                <!-- begin character similarity -->
                <h3>Characters similar to {{ tdata['speaker'] }}</h3>
                {% if tdata['speaker_mlt_series_matches'] %}
                <div class="overflow-scroll" style="max-height: 600px;">
                    <h5>Series-wide:</h5>
                    <table class="table table-hover table-striped table-fit">
                        <thead>
                            <tr class="table-success">
                                <th scope="col">Character</th>
                                <th scope="col">Layer</th>
                                <th scope="col">Score</th>
                                <th scope="col">Rank</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for speaker_mlt_match in tdata['speaker_mlt_series_matches'] %}
                            <tr class="table-light">
                                <th scope="row"><a href="/web/speaker/{{ show_key }}/{{ speaker_mlt_match['speaker'] }}">{{ speaker_mlt_match['speaker'] }}</a></th>
                                <td>{{ speaker_mlt_match['layer_key'] }}</td>
                                <td>{{ '%0.2f'|format(speaker_mlt_match['score']|float) }}</td>
                                <td>{{ speaker_mlt_match['rank'] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p>&nbsp;</p>
                {% endif %}

                {% if tdata['speaker_mlt_season_matches'] %}
                <div class="overflow-scroll" style="max-height: 600px;">
                    {% for season, speaker_mlt_matches in tdata['speaker_mlt_season_matches'].items() %}
                    <h5>Season {{ season }}:</h5>
                    <table class="table table-hover table-striped table-fit">
                        <thead>
                            <tr class="table-success">
                                <th scope="col">Character</th>
                                <th scope="col">Layer</th>
                                <th scope="col">Score</th>
                                <th scope="col">Rank</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for speaker_mlt_match in speaker_mlt_matches %}
                            <tr class="table-light">
                                <th scope="row"><a href="/web/speaker/{{ show_key }}/{{ speaker_mlt_match['speaker'] }}">{{ speaker_mlt_match['speaker'] }}</a></th>
                                <td>{{ speaker_mlt_match['layer_key'] }}</td>
                                <td>{{ '%0.2f'|format(speaker_mlt_match['score']|float) }}</td>
                                <td>{{ speaker_mlt_match['rank'] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endfor %}
                </div>
                <p>&nbsp;</p>
                {% endif %}

                {% if tdata['speaker_mlt_episode_matches'] %}
                <div class="overflow-scroll" style="max-height: 600px;">
                    {% for episode, speaker_mlt_matches in tdata['speaker_mlt_episode_matches'].items() %}
                    <h5>Episode {{ episode }}:</h5>
                    <table class="table table-hover table-striped table-fit">
                        <thead>
                            <tr class="table-success">
                                <th scope="col">Character</th>
                                <th scope="col">Layer</th>
                                <th scope="col">Score</th>
                                <th scope="col">Rank</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for speaker_mlt_match in speaker_mlt_matches %}
                            <tr class="table-light">
                                <th scope="row"><a href="/web/speaker/{{ show_key }}/{{ speaker_mlt_match['speaker'] }}">{{ speaker_mlt_match['speaker'] }}</a></th>
                                <td>{{ speaker_mlt_match['layer_key'] }}</td>
                                <td>{{ '%0.2f'|format(speaker_mlt_match['score']|float) }}</td>
                                <td>{{ speaker_mlt_match['rank'] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endfor %}
                </div>
                <p>&nbsp;</p>
                {% endif %}
                <!-- end character similarity -->

                <!-- begin character-centric search form -->
                <h3>{{ tdata['speaker'] }}-affiliated search</h3>
                <br/>
                <form action="/web/character/{{ tdata['show_key'] }}/{{ tdata['speaker'] }}" method="GET">
                    <!-- https://getbootstrap.com/docs/5.0/components/navs-tabs/#javascript-behavior -->
                    <nav>
                        <div class="nav nav-tabs" id="nav-tab" role="tablist">
                            <button class="nav-link{% if tdata['search_type']=='' or tdata['search_type']=='advanced' %} active{% endif %}" id="nav-advanced-tab" 
                                    data-bs-toggle="tab" data-bs-target="#nav-advanced" type="button" role="tab" aria-controls="nav-advanced" aria-selected="false">
                                Dialog search
                            </button>
                            <button class="nav-link{% if tdata['search_type']=='advanced_multi_speaker' %} active{% endif %}" id="nav-advanced-multi-character-tab" 
                                    data-bs-toggle="tab" data-bs-target="#nav-advanced-multi-character" type="button" role="tab" aria-controls="nav-advanced-multi-character" aria-selected="false">
                                Multi-character search
                            </button>
                        </div>
                    </nav>
                    <br/>
                    <div class="tab-content" id="nav-tabContent">
                        <div class="tab-pane fade{% if tdata['search_type']=='' or tdata['search_type']=='advanced' %} show active{% endif %}" id="nav-advanced" role="tabpanel" aria-labelledby="nav-advanced-tab">
                            <div class="col-10">
                                <div class="row input-group">
                                    <div class="col-3">
                                        <label class="col-form-label">By dialogue:</label>
                                    </div>
                                    <div class="col-6"> 
                                        <input type="text" class="form-control" name="dialog" value="{{ tdata['dialog'] }}" id="dialogInput">
                                    </div>
                                </div>                        
                                <div class="row input-group">
                                    <div class="col-3">
                                        <label class="col-form-label">By location:</label>
                                    </div>
                                    <div class="col-6"> 
                                        <input type="text" class="form-control" name="location" value="{{ tdata['location'] }}" id="locationInput">
                                    </div>
                                </div>
                                <br/>
                                <div class="row input-group">
                                    <div class="col-9">
                                        <button type="submit" class="btn btn-primary" name="search_type" value="advanced">Search</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade{% if tdata['search_type']=='advanced_multi_speaker' %} show active{% endif %}" id="nav-advanced-multi-character" role="tabpanel" aria-labelledby="nav-advanced-multi-character-tab">
                            <div class="col-10">
                                <div class="row input-group">
                                    <div class="col-4">
                                        <label class="col-form-label">By other character(s):</label>
                                    </div>
                                    <div class="col-6"> 
                                        <input type="text" class="form-control" name="speakers" value="{{ tdata['speakers'] }}" id="speakersInput">
                                    </div>
                                </div>                              
                                <div class="row input-group">
                                    <div class="col-4">
                                        <label class="col-form-label">By location:</label>
                                    </div>
                                    <div class="col-6"> 
                                        <input type="text" class="form-control" name="locationAMS" value="{{ tdata['locationAMS'] }}" id="locationAMSInput">
                                    </div>
                                </div>
                                <br/>
                                <div class="row input-group">
                                    <div class="col-6">
                                        <button type="submit" class="btn btn-primary" name="search_type" value="advanced_multi_speaker">Search</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br/>
                </form>
                <br/>
                <!-- end character-centric search form -->

            {% if tdata['search_type'] != '' %}
                <!-- begin search result count summary -->
                <h3><strong>{{ tdata['episode_match_count'] }}</strong> episodes / 
                    <strong>{{ tdata['scene_match_count'] }}</strong> scenes / 
                    <strong>{{ tdata['scene_event_match_count'] }}</strong> lines matching <strong class="gold">"{{ tdata['speaker'] }}"</strong>
                    {% if tdata['search_type'] == 'advanced' %}
                        {% if tdata['dialog'] %} + dialogue: <strong class="gold">"{{ tdata['dialog'] }}"</strong>{% endif %}
                        {% if tdata['location'] %} + location: <strong class="gold">"{{ tdata['location'] }}"</strong>{% endif %}
                    {% endif %}
                    {% if tdata['search_type'] == 'advanced_multi_speaker' %}
                        {% if tdata['speakers'] %} + other characters: <strong class="gold">"{{ tdata['speakers'] }}"</strong>{% endif %}
                        {% if tdata['locationAMS'] %} + location: <strong class="gold">"{{ tdata['locationAMS'] }}"</strong>{% endif %}
                    {% endif %}
                    {% if tdata['season'] %}, Season <strong>{{ tdata['season'] }}</strong>{% endif %}
                </h3>
                <p>&nbsp;</p>
                <!-- end search result count summary -->

                <!-- begin display search results -->
                {% for episode in tdata['episode_matches'] %}
                <div class="card text-white bg-success mb-3 w-75">
                    <div class="card-header">Season {{ episode['season'] }}, Episode {{ episode['sequence_in_season'] }} ({{ episode['air_date']|truncate(10,true,'') }})</div>
                    <div class="card-body">
                        <h5 class="card-title">
                            <button type="button" class="btn btn-primary">{{ '%0.2f'|format(episode['agg_score']|float) }}</button>&nbsp;&nbsp;
                            <a class="alert-link" href="/web/episode/{{ episode['show_key'] }}/{{ episode['episode_key'] }}">{{ episode['title']|safe }}</a> 
                        </h5>
                        <div class="overflow-scroll" style="max-height: 300px;">
                        {% for scene in episode['scenes'] %}
                            <hr>
                            <p>[scene {{ scene['sequence'] }}] <strong>{{ scene['location']|safe }}</strong></p>
                            <p><small>
                            {% for scene_event in scene['scene_events'] %}
                                [line {{ scene_event['sequence'] }}] 
                                {% if scene_event['context_info'] %}
                                    [{{ scene_event['context_info']|safe }}] 
                                {% endif %}
                                {% if scene_event['spoken_by'] %}
                                    <strong>{{ scene_event['spoken_by']|safe }}</strong>: {{ scene_event['dialog']|safe }}
                                {% endif %}
                                <br/>
                            {% endfor %}
                            </small></p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                <!-- end display search results -->

            {% endif %}
            </div>
            <!-- END LEFT COLUMN -->

            <!-- BEGIN RIGHT COLUMN -->
            <div class="col-4">
                <!-- begin speaker topics -->
                {% for topic_grouping, speaker_topics in tdata['child_topics_by_grouping'].items() %}

                <h3>Topics: {{ topic_grouping }}</h3>
                <div class="overflow-scroll" style="max-height: 300px;">
                    <table class="table table-hover table-striped table-fit">
                        <thead>
                            <tr class="table-success">
                                <th scope="col">Key</th>
                                <th scope="col">Name</th>
                                <th scope="col">Score</th>
                                <th scope="col">Raw</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for speaker_topic in speaker_topics %}
                            <tr class="table-secondary">
                                <td>
                                    <a class="text-white" href="/web/topic/{{ tdata['show_key'] }}/{{ topic_grouping }}/{{ speaker_topic['topic_key'] }}">
                                        {{ speaker_topic['topic_key'] }}</a>
                                </td>
                                <td>{{ speaker_topic['topic_name'] }}</td>
                                <td>{{ '%0.2f'|format(speaker_topic['score']|float) }}</td>
                                <td>
                                    {% if speaker_topic['raw_score'] > 0 %}
                                        {{ '%0.2f'|format(speaker_topic['raw_score']|float) }}
                                    {% else %}
                                        (agg)
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if tdata['parent_topics_by_grouping'][topic_grouping] %}
                    <br/>
                    <h5>Broader {{ topic_grouping }} topics:</h5>
                    <div class="overflow-scroll" style="max-height: 300px;">
                        <table class="table table-hover table-striped table-fit">
                            <thead>
                                <tr class="table-success">
                                    <th scope="col">Key</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Score</th>
                                    <th scope="col">Raw</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for speaker_topic in tdata['parent_topics_by_grouping'][topic_grouping] %}
                                <tr class="table-secondary">
                                    <td>
                                        <a class="text-white" href="/web/topic/{{ tdata['show_key'] }}/{{ topic_grouping }}/{{ speaker_topic['topic_key'] }}">
                                            {{ speaker_topic['topic_key'] }}</a>
                                    </td>
                                    <td>{{ speaker_topic['topic_name'] }}</td>
                                    <td>{{ '%0.2f'|format(speaker_topic['score']|float) }}</td>
                                    <td>
                                        {% if speaker_topic['raw_score'] > 0 %}
                                            {{ '%0.2f'|format(speaker_topic['raw_score']|float) }}
                                        {% else %}
                                            (agg)
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
                <p>&nbsp;</p>
				{% endfor %}
                <!-- end speaker topics -->

                <!-- begin speaker locations -->
                <h3>Where is {{ tdata['speaker'] }}?</h3>
                <div class="overflow-scroll" style="max-height: 600px;">
                    <table class="table table-hover table-striped table-fit">
                        <thead>
                            <tr class="table-primary">
                                <th scope="col">Location</th>
                                <th scope="col">Scenes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for location, count in tdata['location_counts'].items() %}
                            <tr class="table-secondary">
                                {% if location == '_ALL_' %}
                                <th scope="row">[ALL]</th>
                                <td><a href="/web/episode_search/{{ tdata['show_key'] }}?speaker={{ tdata['speaker'] }}&search_type=advanced" 
                                    class="alert-link" >{{ count }}</a></td>
                                {% else %}
                                <th scope="row">{{ location }}</th>
                                <td><a href="/web/episode_search/{{ tdata['show_key'] }}?speaker={{ tdata['speaker'] }}&location={{ location }}&search_type=advanced" 
                                    class="alert-link" >{{ count }}</a></td>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p>&nbsp;</p>
                <!-- end speaker locations -->

                <!-- begin who speaker's with -->
                <h3>Who is {{ tdata['speaker'] }} with?</h3>
                <div class="overflow-scroll" style="max-height: 600px;">
                    <table class="table table-hover table-striped table-fit">
                        <thead>
                            <tr class="table-success">
                                <th scope="col">Character</th>
                                <th scope="col">Episodes</th>
                                <th scope="col">Scenes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for other_speaker_aggs in tdata['other_speaker_agg_composite'] %}
                            <tr class="table-secondary">
                                <th scope="row"><a class="alert-link" href="/web/character/{{ tdata['show_key'] }}/{{ other_speaker_aggs['other_speaker'] }}">{{ other_speaker_aggs['other_speaker'] }}</a></th>
                                <td><a href="/web/episode_search/{{ tdata['show_key'] }}?speakers={{ tdata['speaker'] }},{{ other_speaker_aggs['other_speaker'] }}&search_type=advanced_multi_speaker" 
                                        class="alert-link" >{{ other_speaker_aggs['episode_count'] }}</a></td>
                                <td>{{ other_speaker_aggs['scene_count'] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p>&nbsp;</p>
                <!-- end who speaker's with -->

                <!-- begin speaker-to-speaker vector similarity -->
                <h3>Who sounds like {{ tdata['speaker'] }}?</h3>
                <div class="overflow-scroll" style="max-height: 600px;">
                    <table class="table table-hover table-striped table-fit">
                        <thead>
                            <tr class="table-success">
                                <th scope="col">Character</th>
                                <th scope="col">Agg score?</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for speaker_mlt, agg_score in tdata['speaker_mlt_aggs'].items() %}
                            <tr class="table-secondary">
                                <th scope="row"><a class="alert-link" href="/web/character/{{ tdata['show_key'] }}/{{ speaker_mlt }}">{{ speaker_mlt }}</a></th>
                                <td>{{ agg_score }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p>&nbsp;</p>
                <!-- end speaker-to-speaker vector similarity -->

            </div>
            <!-- END RIGHT COLUMN -->

        </div>
        <!-- END FIRST ROW -->
		
    </div>
{% endblock %} 